{
  "id": "snapshot_1769734581783_4z2bh6yn2",
  "approvalId": "approval_1769734581781_mw65lpypk",
  "approvalTitle": "Design: Multi-Agent Shogun Integration",
  "version": 1,
  "timestamp": "2026-01-30T00:56:21.783Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: Multi-Agent Shogun Integration\n\n## Overview\n\nmulti-agent-shogunをclaude-code-managerにフル統合し、将軍-家老-足軽の階層構造で複数のClaude Codeインスタンスを協調動作させる「将軍モード」を実装する。\n\n既存のTmuxManager、SessionOrchestrator、TtydManagerを再利用・拡張し、新たにShogunOrchestratorとFileWatcherを追加する。\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n- TypeScript + ESM\n- Express + Socket.IO（バックエンド）\n- React 19 + TailwindCSS + shadcn/ui（フロントエンド）\n- EventEmitterベースのイベント駆動設計\n\n### Project Structure (structure.md)\n```\nserver/lib/     # バックエンドロジック\nclient/src/     # フロントエンド\n  components/   # UIコンポーネント\n  hooks/        # カスタムフック\nshared/         # 共有型定義\n```\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **TmuxManager**: tmuxセッション作成・キー送信・セッション復元をそのまま再利用\n- **TtydManager**: ttydインスタンス起動・ポート管理をそのまま再利用\n- **SessionOrchestrator**: イベントフォワーディングパターンを参考に設計\n- **MultiPaneLayout**: グリッドレイアウト・最大化機能を拡張\n- **useSocket**: Socket.IO接続管理・イベントハンドリングを拡張\n\n### Integration Points\n\n- **既存SessionOrchestrator**: 将軍モードは独立したオーケストレーターとして実装、既存機能と共存\n- **Socket.IOイベント**: 既存イベントに加え、`shogun:*`プレフィックスのイベントを追加\n- **Database**: 既存のSQLiteスキーマにshogun_modesテーブルを追加\n\n## Architecture\n\n```mermaid\ngraph TD\n    subgraph Client\n        Dashboard[Dashboard.tsx]\n        ShogunTab[Shogun タブ]\n        ShogunLayout[ShogunModeLayout]\n        DashViewer[DashboardViewer]\n        QueueViewer[QueueViewer]\n        useShogun[useShogunMode Hook]\n    end\n\n    subgraph Server\n        SocketHandler[Socket Handlers]\n        ShogunOrch[ShogunOrchestrator]\n        FileWatch[FileWatcher]\n        TmuxMgr[TmuxManager]\n        TtydMgr[TtydManager]\n    end\n\n    subgraph tmux\n        Shogun[将軍 Session]\n        Karo[家老 Session]\n        Ashigaru1[足軽1 Session]\n        Ashigaru2[足軽2 Session]\n        Ashigaru3[足軽3 Session]\n        Ashigaru4[足軽4 Session]\n    end\n\n    subgraph FileSystem\n        Instructions[instructions/]\n        Queue[queue/*.yaml]\n        DashMd[dashboard.md]\n    end\n\n    Dashboard --> ShogunTab\n    ShogunTab --> ShogunLayout\n    ShogunLayout --> DashViewer\n    ShogunLayout --> QueueViewer\n    ShogunLayout --> useShogun\n\n    useShogun -->|Socket.IO| SocketHandler\n    SocketHandler --> ShogunOrch\n    ShogunOrch --> TmuxMgr\n    ShogunOrch --> TtydMgr\n    ShogunOrch --> FileWatch\n\n    TmuxMgr --> Shogun\n    TmuxMgr --> Karo\n    TmuxMgr --> Ashigaru1\n    TmuxMgr --> Ashigaru2\n    TmuxMgr --> Ashigaru3\n    TmuxMgr --> Ashigaru4\n\n    FileWatch --> Queue\n    FileWatch --> DashMd\n    ShogunOrch --> Instructions\n```\n\n### Modular Design Principles\n\n- **Single File Responsibility**: ShogunOrchestratorは将軍モード管理のみ、FileWatcherはファイル監視のみ\n- **Component Isolation**: 将軍モード関連コンポーネントは既存コンポーネントと分離\n- **Service Layer Separation**: Orchestrator（ビジネスロジック）とManager（インフラ）を分離\n- **Utility Modularity**: instructions読み込み、YAMLパースは独立モジュール化\n\n## Components and Interfaces\n\n### ShogunOrchestrator (server/lib/shogun-orchestrator.ts)\n\n- **Purpose**: 将軍モード全体のライフサイクル管理\n- **Interfaces**:\n  ```typescript\n  class ShogunOrchestrator extends EventEmitter {\n    startShogunMode(worktreePath: string, ashigaruCount?: number): Promise<ShogunMode>\n    stopShogunMode(modeId: string): Promise<void>\n    getShogunMode(modeId: string): ShogunMode | undefined\n    getShogunModeByWorktree(worktreePath: string): ShogunMode | undefined\n    getAllShogunModes(): ShogunMode[]\n    sendToRole(modeId: string, role: Role, message: string): void\n  }\n  ```\n- **Dependencies**: TmuxManager, TtydManager, FileWatcher\n- **Reuses**: EventEmitterパターン（SessionOrchestrator参考）\n\n### FileWatcher (server/lib/file-watcher.ts)\n\n- **Purpose**: queue/*.yaml と dashboard.md の変更監視\n- **Interfaces**:\n  ```typescript\n  class FileWatcher extends EventEmitter {\n    watch(worktreePath: string, modeId: string): void\n    unwatch(modeId: string): void\n    getQueueData(modeId: string): QueueData | null\n    getDashboardContent(modeId: string): string | null\n  }\n  // Events: 'queue:updated', 'dashboard:updated'\n  ```\n- **Dependencies**: chokidar, js-yaml\n- **Reuses**: EventEmitterパターン\n\n### ShogunModeLayout (client/src/components/ShogunModeLayout.tsx)\n\n- **Purpose**: 将軍モード専用の階層レイアウト\n- **Interfaces**:\n  ```typescript\n  interface ShogunModeLayoutProps {\n    mode: ShogunMode;\n    sessions: Map<string, TtydSession>;\n    dashboard: string | null;\n    queue: QueueData | null;\n    onSendMessage: (sessionId: string, message: string) => void;\n    onSendKey: (sessionId: string, key: string) => void;\n    onStopMode: () => void;\n  }\n  ```\n- **Dependencies**: TerminalPane, DashboardViewer, QueueViewer\n- **Reuses**: MultiPaneLayoutのグリッドシステム\n\n### useShogunMode (client/src/hooks/useShogunMode.ts)\n\n- **Purpose**: 将軍モードの状態管理とSocket.IO通信\n- **Interfaces**:\n  ```typescript\n  function useShogunMode(): {\n    shogunMode: ShogunMode | null;\n    isStarting: boolean;\n    dashboard: string | null;\n    queue: QueueData | null;\n    startShogunMode: (worktreePath: string) => void;\n    stopShogunMode: () => void;\n    sendToShogun: (message: string) => void;\n  }\n  ```\n- **Dependencies**: useSocket\n- **Reuses**: useSocketのイベントハンドリングパターン\n\n## Data Models\n\n### ShogunMode\n```typescript\ninterface ShogunMode {\n  id: string;\n  worktreePath: string;\n  status: 'starting' | 'running' | 'stopping' | 'stopped' | 'error';\n  shogunSessionId: string;\n  karoSessionId: string;\n  ashigaruSessionIds: string[];  // 4 sessions\n  createdAt: Date;\n  lastActivity: Date;\n}\n```\n\n### QueueData\n```typescript\ninterface QueueData {\n  shogunToKaro: {\n    command_id: string;\n    content: string;\n    status: string;\n    timestamp: string;\n  } | null;\n  karoToAshigaru: Map<number, {\n    task_id: string;\n    content: string;\n    status: string;\n    assigned_to: number;\n  }>;\n}\n```\n\n### Role\n```typescript\ntype Role = 'shogun' | 'karo' | 'ashigaru1' | 'ashigaru2' | 'ashigaru3' | 'ashigaru4';\n```\n\n## Socket.IO Events\n\n### Client → Server\n\n| Event | Payload | Description |\n|-------|---------|-------------|\n| `shogun:start` | `{ worktreePath: string }` | 将軍モード起動 |\n| `shogun:stop` | `{ modeId: string }` | 将軍モード停止 |\n| `shogun:sendToRole` | `{ modeId: string, role: Role, message: string }` | 特定ロールにメッセージ送信 |\n| `shogun:sendKey` | `{ modeId: string, role: Role, key: string }` | 特定ロールにキー送信 |\n\n### Server → Client\n\n| Event | Payload | Description |\n|-------|---------|-------------|\n| `shogun:started` | `ShogunMode` | 将軍モード起動完了 |\n| `shogun:stopped` | `{ modeId: string }` | 将軍モード停止完了 |\n| `shogun:status` | `{ modeId: string, status: string }` | ステータス更新 |\n| `shogun:dashboard` | `{ modeId: string, content: string }` | dashboard.md更新 |\n| `shogun:queue` | `{ modeId: string, queue: QueueData }` | キュー更新 |\n| `shogun:error` | `{ modeId: string, error: string }` | エラー |\n\n## tmux Session Naming\n\n| Role | Session Name Pattern | Example |\n|------|---------------------|---------|\n| 将軍 | `ccm-shg-{shortId}` | `ccm-shg-abc123` |\n| 家老 | `ccm-kro-{shortId}` | `ccm-kro-abc123` |\n| 足軽1 | `ccm-as1-{shortId}` | `ccm-as1-abc123` |\n| 足軽2 | `ccm-as2-{shortId}` | `ccm-as2-abc123` |\n| 足軽3 | `ccm-as3-{shortId}` | `ccm-as3-abc123` |\n| 足軽4 | `ccm-as4-{shortId}` | `ccm-as4-abc123` |\n\n## File Structure (New/Modified)\n\n```\nserver/lib/\n├── shogun-orchestrator.ts    # NEW: 将軍モード管理\n├── file-watcher.ts           # NEW: ファイル監視\n├── instructions-loader.ts    # NEW: instructions読み込み\n└── shogun-socket-handlers.ts # NEW: Socket.IOハンドラー\n\nclient/src/\n├── components/\n│   ├── ShogunModeLayout.tsx  # NEW: 階層レイアウト\n│   ├── DashboardViewer.tsx   # NEW: dashboard.md表示\n│   ├── QueueViewer.tsx       # NEW: キュー表示\n│   └── RolePane.tsx          # NEW: ロール別ペイン\n├── hooks/\n│   └── useShogunMode.ts      # NEW: 将軍モードフック\n└── pages/\n    └── Dashboard.tsx         # MODIFIED: Shogunタブ追加\n\nshared/\n└── types.ts                  # MODIFIED: 型追加\n\ninstructions/                 # NEW: multi-agent-shogunから移植\n├── shogun.md\n├── karo.md\n└── ashigaru.md\n\ntemplates/                    # NEW: テンプレート\n├── dashboard.md\n└── queue/\n    ├── shogun_to_karo.yaml\n    └── karo_to_ashigaru.yaml\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **セッション起動失敗**\n   - **Handling**: 部分的に起動したセッションをクリーンアップ、エラーイベント発行\n   - **User Impact**: エラーメッセージ表示、再試行ボタン\n\n2. **tmuxセッション消失**\n   - **Handling**: 定期的なヘルスチェックで検出、ステータスを'error'に更新\n   - **User Impact**: ペインに警告表示、再起動オプション\n\n3. **ファイル監視エラー**\n   - **Handling**: エラーログ出力、監視継続を試みる\n   - **User Impact**: ダッシュボード/キュー表示が更新されない旨を通知\n\n4. **WebSocket切断**\n   - **Handling**: 既存のuseSocket再接続ロジックを継承\n   - **User Impact**: 接続状態インジケーター表示\n\n## Testing Strategy\n\n### Unit Testing\n- ShogunOrchestrator: セッション起動/停止ロジック\n- FileWatcher: ファイル変更検知\n- 各コンポーネントの個別テスト\n\n### Integration Testing\n- Socket.IOイベント送受信\n- tmuxセッションとttydの連携\n- ファイル変更→UI更新フロー\n\n### End-to-End Testing\n- 将軍モード起動→指示送信→停止の一連フロー\n- 既存機能（通常セッション）との共存確認\n- リモートアクセス時の動作確認\n",
  "fileStats": {
    "size": 10693,
    "lines": 323,
    "lastModified": "2026-01-30T00:56:16.550Z"
  },
  "comments": []
}